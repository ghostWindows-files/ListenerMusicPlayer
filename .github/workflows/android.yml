name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 JDK 8 (配合 Gradle 2.14 必须用这个)
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'gradle'

    # 3. 【核心步骤】使用 Python 脚本精准替换仓库源
    # 不删任何插件，只是把下载地址指向阿里云
    - name: Switch to Aliyun Mirrors
      shell: python
      run: |
        import os

        # 定义阿里云的仓库配置（包含 Google 和 JCenter/Central 的镜像）
        aliyun_repos = """
        maven { url 'https://maven.aliyun.com/repository/google' }
        maven { url 'https://maven.aliyun.com/repository/public' }
        """

        file_path = 'build.gradle'
        
        print(f"Reading {file_path}...")
        with open(file_path, 'r') as f:
            content = f.read()

        # 将所有的 jcenter() 替换为阿里云镜像
        if 'jcenter()' in content:
            new_content = content.replace('jcenter()', aliyun_repos)
            
            with open(file_path, 'w') as f:
                f.write(new_content)
            print("SUCCESS: Replaced jcenter() with Aliyun mirrors.")
        else:
            print("WARNING: jcenter() not found, skipping replacement.")
            
        # 顺便打印一下修改后的文件，方便你在日志里检查
        print("-" * 20)
        print(new_content)
        print("-" * 20)

    # 4. 赋予 gradlew 执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 5. 编译 (带堆栈日志，方便排错)
    - name: Build with Gradle
      run: ./gradlew assembleDebug --stacktrace

    # 6. 上传 APK
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: app/build/outputs/apk/debug/app-debug.apk
