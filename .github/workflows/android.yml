name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 JDK 8 (Gradle 4.x 最佳搭档)
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'gradle'

    # 3. 强制升级 Gradle Wrapper (2.14 -> 4.10.1)
    # 只有升级到这里，才能解决 XML 解析报错
    - name: Upgrade Gradle Wrapper
      run: |
        sed -i 's/gradle-2.14.1-all.zip/gradle-4.10.1-all.zip/' gradle/wrapper/gradle-wrapper.properties

    # 4. 【暴力覆盖】重写根目录 build.gradle
    # 使用 AGP 3.3.2 插件，彻底解决 'extension-level' XML 报错
    - name: Overwrite Root build.gradle
      run: |
        cat > build.gradle <<EOF
        buildscript {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
            }
            dependencies {
                // 升级插件到 3.3.2，这是救活老项目的关键
                classpath 'com.android.tools.build:gradle:3.3.2'
            }
        }
        allprojects {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url "https://jitpack.io" }
            }
        }
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

    # 5. 【暴力覆盖】重写 app/build.gradle
    # 1. 删除 AndResGuard (如你所愿)
    # 2. 语法升级 (compile -> implementation)
    # 3. 修复 apt
    - name: Overwrite App build.gradle
      run: |
        cat > app/build.gradle <<EOF
        apply plugin: 'com.android.application'

        android {
            // 升级编译版本，配合 Gradle 4.10
            compileSdkVersion 28
            buildToolsVersion "28.0.3"

            defaultConfig {
                applicationId "io.hefuyi.listener"
                minSdkVersion 16
                targetSdkVersion 28
                versionCode 1
                versionName "1.0b"
                testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
                renderscriptTargetApi 21
                renderscriptSupportModeEnabled true
                resConfigs "zh","en"
                
                // 必须加这个，防止 dimension 报错
                flavorDimensions "default"
                
                ndk {
                    abiFilters "armeabi", "armeabi-v7a" ,"x86"
                }
            }

            buildTypes {
                release {
                    minifyEnabled true
                    shrinkResources true
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
                debug {
                    minifyEnabled false
                    versionNameSuffix "_debug"
                }
            }
            
            // 指定 Java 8 编译
            compileOptions {
                sourceCompatibility 1.8
                targetCompatibility 1.8
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            
            // 测试库
            androidTestImplementation('com.android.support.test.espresso:espresso-core:2.2.2', {
                exclude group: 'com.android.support', module: 'support-annotations'
            })
            testImplementation 'junit:junit:4.12'

            // Support 库
            implementation 'com.android.support:appcompat-v7:24.2.1'
            implementation 'com.android.support:recyclerview-v7:24.2.1'
            implementation 'com.android.support:cardview-v7:24.2.1'
            implementation 'com.android.support:palette-v7:24.2.1'
            implementation 'com.android.support:design:24.2.1'

            // RxJava
            implementation 'io.reactivex:rxandroid:1.2.1'
            implementation 'io.reactivex:rxjava:1.1.6'

            // Glide
            implementation 'com.github.bumptech.glide:glide:3.7.0'

            // ButterKnife (apt -> annotationProcessor)
            implementation 'com.jakewharton:butterknife:8.4.0'
            annotationProcessor 'com.jakewharton:butterknife-compiler:8.4.0'

            // Retrofit
            implementation 'com.squareup.retrofit2:retrofit:2.1.0'
            implementation 'com.squareup.retrofit2:converter-gson:2.1.0'
            implementation 'com.squareup.retrofit2:adapter-rxjava:2.0.1'
            implementation 'com.squareup.okhttp3:logging-interceptor:3.3.0'

            // MaterialIcon
            implementation 'net.steamcrafted:materialiconlib:1.1.1'

            // Dagger2 (apt -> annotationProcessor)
            implementation 'com.google.dagger:dagger:2.0'
            annotationProcessor 'com.google.dagger:dagger-compiler:2.0'
            compileOnly 'org.glassfish:javax.annotation:10.0-b28'

            // MaterialDialogs
            implementation 'com.afollestad.material-dialogs:core:0.9.1.0'

            // ImageLoader
            implementation 'com.nostra13.universalimageloader:universal-image-loader:1.9.4'

            // SlidingUpPanel
            implementation 'com.sothree.slidinguppanel:library:3.3.1'

            // App Theme Engine
            implementation('com.github.naman14:app-theme-engine:0.5.2@aar') {
                transitive = true
            }
        }
        EOF

    # 6. 赋予执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 7. 编译
    - name: Build with Gradle
      run: ./gradlew assembleDebug --stacktrace

    # 8. 上传
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: app/build/outputs/apk/debug/app-debug.apk
