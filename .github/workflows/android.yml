name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 JDK 8
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'gradle'

    # 3. 升级 Gradle Wrapper (2.14 -> 4.10.1)
    - name: Upgrade Gradle Wrapper
      run: |
        sed -i 's/gradle-2.14.1-all.zip/gradle-4.10.1-all.zip/' gradle/wrapper/gradle-wrapper.properties

    # 4. 重写根目录 build.gradle (使用 AGP 3.3.2 + 阿里云)
    - name: Overwrite Root build.gradle
      run: |
        cat > build.gradle <<EOF
        buildscript {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:3.3.2'
            }
        }
        allprojects {
            repositories {
                maven { url 'https://maven.aliyun.com/repository/google' }
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url "https://jitpack.io" }
            }
        }
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

    # 5. 重写 app/build.gradle (升级 SDK 到 28，修复 apt)
    - name: Overwrite App build.gradle
      run: |
        cat > app/build.gradle <<EOF
        apply plugin: 'com.android.application'

        android {
            compileSdkVersion 28
            buildToolsVersion "28.0.3"

            defaultConfig {
                applicationId "io.hefuyi.listener"
                minSdkVersion 16
                targetSdkVersion 28
                versionCode 1
                versionName "1.0b"
                testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
                renderscriptTargetApi 21
                renderscriptSupportModeEnabled true
                resConfigs "zh","en"
                flavorDimensions "default"
                ndk {
                    abiFilters "armeabi", "armeabi-v7a" ,"x86"
                }
            }
            buildTypes {
                release {
                    minifyEnabled true
                    shrinkResources true
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
                debug {
                    minifyEnabled false
                    versionNameSuffix "_debug"
                }
            }
            compileOptions {
                sourceCompatibility 1.8
                targetCompatibility 1.8
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            testImplementation 'junit:junit:4.12'
            
            // Support Libraries
            implementation 'com.android.support:appcompat-v7:24.2.1'
            implementation 'com.android.support:recyclerview-v7:24.2.1'
            implementation 'com.android.support:cardview-v7:24.2.1'
            implementation 'com.android.support:palette-v7:24.2.1'
            implementation 'com.android.support:design:24.2.1'

            // Third Party
            implementation 'io.reactivex:rxandroid:1.2.1'
            implementation 'io.reactivex:rxjava:1.1.6'
            implementation 'com.github.bumptech.glide:glide:3.7.0'
            
            // ButterKnife
            implementation 'com.jakewharton:butterknife:8.4.0'
            annotationProcessor 'com.jakewharton:butterknife-compiler:8.4.0'

            // Retrofit
            implementation 'com.squareup.retrofit2:retrofit:2.1.0'
            implementation 'com.squareup.retrofit2:converter-gson:2.1.0'
            implementation 'com.squareup.retrofit2:adapter-rxjava:2.0.1'
            implementation 'com.squareup.okhttp3:logging-interceptor:3.3.0'

            implementation 'net.steamcrafted:materialiconlib:1.1.1'
            implementation 'com.afollestad.material-dialogs:core:0.9.1.0'
            implementation 'com.nostra13.universalimageloader:universal-image-loader:1.9.4'
            implementation 'com.sothree.slidinguppanel:library:3.3.1'
            
            // Dagger
            implementation 'com.google.dagger:dagger:2.0'
            annotationProcessor 'com.google.dagger:dagger-compiler:2.0'
            compileOnly 'org.glassfish:javax.annotation:10.0-b28'

            implementation('com.github.naman14:app-theme-engine:0.5.2@aar') {
                transitive = true
            }
        }
        EOF

    # 6. 【新增】自动修复 Java 源码报错
    # 替换过时的 canvas.save(FLAG) 为 canvas.save()
    - name: Fix Java Source Code (API 28 Compatibility)
      run: |
        sed -i 's/canvas.save(Canvas.MATRIX_SAVE_FLAG)/canvas.save()/g' app/src/main/java/io/hefuyi/listener/widget/fastscroller/FastScrollPopup.java

    # 7. 赋予执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 8. 编译
    - name: Build with Gradle
      run: ./gradlew assembleDebug --stacktrace

    # 9. 上传
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: app/build/outputs/apk/debug/app-debug.apk
