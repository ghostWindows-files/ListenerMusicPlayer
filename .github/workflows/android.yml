name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 JDK 8
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'gradle'

    # 3. 【暴力重写】直接覆盖根目录 build.gradle
    # 确保 MavenCentral (美国节点) 排在第一位，Aliyun (中国节点) 排在最后只做替补
    - name: Overwrite root build.gradle
      run: |
        cat > build.gradle <<EOF
        buildscript {
            repositories {
                mavenCentral()
                maven { url 'https://maven.google.com' }
                maven { url 'https://maven.aliyun.com/repository/public' }
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:2.2.0'
                classpath 'com.neenbedankt.gradle.plugins:android-apt:1.8'
                classpath 'com.tencent.mm:AndResGuard-gradle-plugin:1.2.0'
            }
        }
        allprojects {
            repositories {
                mavenCentral()
                maven { url 'https://maven.google.com' }
                maven { url 'https://maven.aliyun.com/repository/public' }
                maven { url "https://jitpack.io" }
            }
        }
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

    # 4. 【修复报错】手动创建 analytics.settings 防止 Crash
    # 这一步专门解决 FileNotFoundException
    - name: Fix Android Analytics Crash
      run: |
        mkdir -p /home/runner/.android
        touch /home/runner/.android/analytics.settings
        chmod 777 /home/runner/.android/analytics.settings

    # 5. 赋予 gradlew 执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 6. 编译 (禁用守护进程以节省内存)
    - name: Build with Gradle
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    # 7. 上传 APK
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: app/build/outputs/apk/debug/app-debug.apk
