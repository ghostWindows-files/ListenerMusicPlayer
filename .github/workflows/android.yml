name: Android CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 检出代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 设置 JDK 8 (必须)
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: 'gradle'

    # 3. 【核心步骤】对Gradle配置进行“外科手术”
    - name: Fix Obsolete Gradle Configuration
      run: |
        # 3.1: 升级 Gradle 版本 (从 2.14.1 -> 4.10.1)
        echo ">> 1. Upgrading Gradle Wrapper..."
        sed -i 's/gradle-2.14.1-all.zip/gradle-4.10.1-all.zip/' gradle/wrapper/gradle-wrapper.properties

        # 3.2: 升级根 build.gradle，替换仓库，升级安卓插件，删除已失效的插件
        echo ">> 2. Patching root build.gradle..."
        sed -i 's/jcenter()/google()\n        mavenCentral()/' build.gradle
        sed -i "s/com.android.tools.build:gradle:2.2.0/com.android.tools.build:gradle:3.3.2/" build.gradle
        sed -i "/AndResGuard-gradle-plugin/d" build.gradle
        sed -i "/android-apt/d" build.gradle
        
        # 3.3: 修改 app/build.gradle，移除失效插件，并将 'apt' 替换为 'annotationProcessor'
        echo ">> 3. Patching app/build.gradle..."
        sed -i "/apply plugin: 'com.neenbedankt.android-apt'/d" app/build.gradle
        sed -i "/apply plugin: 'AndResGuard'/d" app/build.gradle
        sed -i "s/apt /annotationProcessor /" app/build.gradle
        sed -i '/andResGuard {/,/}/d' app/build.gradle
        
        echo ">> Gradle files have been surgically modified for compatibility."

    # 4. 授予 gradlew 执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 5. 编译项目 (如果再失败，日志会告诉我们新的问题)
    - name: Build with Gradle
      run: ./gradlew assembleDebug --stacktrace

    # 6. 上传编译产物 (APK)
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: app/build/outputs/apk/debug/app-debug.apk
